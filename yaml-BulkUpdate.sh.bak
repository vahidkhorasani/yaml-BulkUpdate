#!/bin/sh
# Make sure you have 'git & yamllint' installed on your system before going any further !
WD="$HOME/test"
	if [[ ! -d $WD || $(ls $WD) == "" ]];then
	    mkdir -p $WD
	    echo "$WD is empty, please clone at least one project in it !!"
	fi
FILE_LIST="$WD/.list"
	if [[ ! -f $FILE_LIST ]]; then
	    touch $FILE_LIST
	fi
PR_NAME=$(ls -1 $WD > $FILE_LIST)
CHNG_FILE="$WD/.changes"
CASE_FILE="$WD/.files"
LOG_DIR="/tmp/logs"
	if [[ ! -d $LOG_DIR ]]; then
	    mkdir $LOG_DIR
	fi
drev_lim='REV_HIST_LIM="1"'
dmem_lim='RSRC_MEM_LIM="512Mi"'
dcpu_lim='RSRC_CPU_LIM="1"'
srev_lim='REV_HIST_LIM="1"'
smem_lim='RSRC_MEM_LIM="512Mi"'
scpu_lim='RSRC_CPU_LIM="1"'
prev_lim='REV_HIST_LIM="5"'
pmem_lim='RSRC_MEM_LIM="4Gi"'
pcpu_lim='RSRC_CPU_LIM="4"'
r='resources:'
l='limits:'
m='memory: "$RSRC_MEM_LIM"'
c='cpu: "$RSRC_CPU_LIM"'
rev='revisionHistoryLimit: $REV_HIST_LIM'
x=2

# Make test directory to clone your projects into it ! 
# Use git to clone your project in ~/test if you've not already !

	if [[ ! -f /usr/bin/yamllint ]]; then
		echo "Please install yamllint before continuing this script !!"
		echo "--------------------------------------------------------"
	fi

while read line 
	do 
		y=$line
		LOG_FILE_ERROR="$LOG_DIR/$y-error.log"
		LOG_FILE_SUCCESS="$LOG_DIR/$y.log"
		if [[ ! -d $WD/$line/ci/k8s ]]; then
    		echo "Can't find 'k8s' directory in $WD/$line !!" >> $LOG_FILE_ERROR
			echo "no k8s directory for $line, Check logs in $LOG_DIR"
			echo "---------------------------------------------------"
			break
		fi

		f=$(find $WD/$line/ci/k8s/ -type f -name "*$line*")
		if [[ -z $f ]];then
			echo "Can not find environments/deployment files with CI_PROJECT_NAME in $line" >> $LOG_FILE_ERROR
			echo "Error finding k8s files for $line, Check logs in $LOG_DIR"
			echo "----------------------------------------------------------"
			break
		fi

		cd $WD/$line/
		z=$(git diff)
		if [[ ! -z $z ]]; then
			echo "You have unsaved changes in $WD/$line/ please commit them first !!" >> $LOG_FILE_ERROR
			echo "Unsaved changes for $line, Check logs in $LOG_DIR"
			echo "--------------------------------------------------"
			break
		fi

		declare -i bdl=$(find $WD/$line/ci/k8s -iname "*$line*env-dev" | xargs -I {} cat {} | wc -l)
		declare -i bsl=$(find $WD/$line/ci/k8s -iname "*$line*env-stage" | xargs -I {} cat {} | wc -l)
		declare -i bpl=$(find $WD/$line/ci/k8s -iname "*$line*env-prod" | xargs -I {} cat {} | wc -l)
		declare -i bdepl=$(find $WD/$line/ci/k8s -iname "*$line*deployment.yaml" | xargs -I {} cat {} | wc -l)

		#### Setting Dev Environment Variables
		echo "Setting Dev Environment Variables for $line ..."

		DEV=$(find $WD/$line/ci/k8s/ -iname "*$line*env-dev")
		if [[ $(echo $DEV | wc -l) -gt 1 ]];then 
			echo "Check $LOG_FILE_ERROR"
			cat <<- BLOCK
  	      	Found more than 1 env file for DEV,
  	      	please specify the one you need to edit by temporarily moving the the others
			BLOCK >> $LOG_FILE_ERROR
			break
		fi
		declare -i DRPL_LINE=$(find $WD/$line/ci/k8s/ -iname "*$line*env-dev" | xargs -I {} cat {} | nl | grep RPL | cut -d$'\t' -f1 | sed  's/^ *//g')
		declare -i DREV_LINE="$DRPL_LINE+1"
		declare -i DMEM_LINE="$DRPL_LINE+2"
		declare -i DCPU_LINE="$DRPL_LINE+3"

		drev_lim='REV_HIST_LIM="1"'
		dmem_lim='RSRC_MEM_LIM="512Mi"'
		dcpu_lim='RSRC_CPU_LIM="1"'

		w=$(grep -c REV_HIST_LIM $DEV)
		if [[ $w == 0 ]]; then
			sed -i '/RPL/ a \ \' $DEV
			printf "%*s%s" $x '' "$drev_lim" | sed -i "${DREV_LINE}"'e cat /dev/stdin' $DEV
		fi

		w=$(grep -c RSRC_MEM_LIM $DEV)
		if [[ $w == 0 ]]; then
			sed -i '/REV_HIST_LIM/ a \ \' $DEV
			printf "%*s%s" $x '' "$dmem_lim" | sed -i "${DMEM_LINE}"'e cat /dev/stdin' $DEV
		fi

		w=$(grep -c RSRC_CPU_LIM $DEV)
		if [[ $w == 0 ]]; then
			sed -i '/RSRC_MEM_LIM/ a \ \' $DEV
			printf "%*s%s" $x '' "$dcpu_lim" | sed -i "${DCPU_LINE}"'e cat /dev/stdin' $DEV
		fi

		echo "Finished"
		echo "------------------------"

		#### Setting Stage Environment Variables
		echo "Setting Stage Environment Variables for $line ..."

		STAGE=$(find $WD/$line/ci/k8s/ -iname "*$line*env-stage")
		if [[ $(echo $STAGE | wc -l) -gt 1 ]];then 
			echo "Check $LOG_FILE_ERROR"
			cat <<- BLOCK
  	      	Found more than 1 env file for STAGE,
  	      	please specify the one you need to edit by temporarily moving the others
			BLOCK >> $LOG_FILE_ERROR
			break
		fi
		declare -i SRPL_LINE=$(find $WD/$line/ci/k8s/ -iname "*$line*env-stage" | xargs -I {} cat {} | nl | grep RPL | cut -d$'\t' -f1 | sed  's/^ *//g')
		declare -i SREV_LINE="$SRPL_LINE+1"
		declare -i SMEM_LINE="$SRPL_LINE+2"
		declare -i SCPU_LINE="$SRPL_LINE+3"

		srev_lim='REV_HIST_LIM="1"'
		smem_lim='RSRC_MEM_LIM="512Mi"'
		scpu_lim='RSRC_CPU_LIM="1"'

		w=$(grep -c REV_HIST_LIM $STAGE)
		if [[ $w == 0 ]]; then
			sed -i '/RPL/ a \ \' $STAGE
			printf "%*s%s" $x '' "$srev_lim" | sed -i "${SREV_LINE}"'e cat /dev/stdin' $STAGE
		fi

		w=$(grep -c RSRC_MEM_LIM $STAGE)
		if [[ $w == 0 ]]; then
			sed -i '/REV_HIST_LIM/ a \ \' $STAGE
			printf "%*s%s" $x '' "$smem_lim" | sed -i "${SMEM_LINE}"'e cat /dev/stdin' $STAGE
		fi

		w=$(grep -c RSRC_CPU_LIM $STAGE)
		if [[ $w == 0 ]]; then
			sed -i '/RSRC_MEM_LIM/ a \ \' $STAGE
			printf "%*s%s" $x '' "$scpu_lim" | sed -i "${SCPU_LINE}"'e cat /dev/stdin' $STAGE
		fi

		echo "Finished"
		echo "------------------------"

		#### Setting Production Environment Variables
		echo "Setting Production Environment Variables for $line ..."

		PROD=$(find $WD/$line/ci/k8s/ -iname "*$line*env-prod")
		if [[ $(echo $PROD | wc -l) -gt 1 ]];then 
			echo "Check $LOG_FILE_ERROR"
			cat <<- BLOCK
  	      	Found more than 1 env file for PRODUCTION,
  	      	please specify the one you need to edit by temporarily moving the others
			BLOCK >> $LOG_FILE_ERROR
			break
		fi
		declare -i PRPL_LINE=$(find $WD/$line/ci/k8s/ -iname "*$line*env-prod" | xargs -I {} cat {} | nl | grep RPL | cut -d$'\t' -f1 | sed  's/^ *//g')
		declare -i PREV_LINE="$PRPL_LINE+1"
		declare -i PMEM_LINE="$PRPL_LINE+2"
		declare -i PCPU_LINE="$PRPL_LINE+3"

		prev_lim='REV_HIST_LIM="5"'
		pmem_lim='RSRC_MEM_LIM="4Gi"'
		pcpu_lim='RSRC_CPU_LIM="4"'

		w=$(grep -c REV_HIST_LIM $PROD)
		if [[ $w == 0 ]]; then
			sed -i '/RPL/ a \ \' $PROD
			printf "%*s%s" $x '' "$prev_lim" | sed -i "${PREV_LINE}"'e cat /dev/stdin' $PROD
		fi

		w=$(grep -c RSRC_MEM_LIM $PROD)
		if [[ $w == 0 ]]; then
			sed -i '/REV_HIST_LIM/ a \ \' $PROD
			printf "%*s%s" $x '' "$pmem_lim" | sed -i "${PMEM_LINE}"'e cat /dev/stdin' $PROD
		fi

		w=$(grep -c RSRC_CPU_LIM $PROD)
		if [[ $w == 0 ]]; then
			sed -i '/RSRC_MEM_LIM/ a \ \' $PROD
			printf "%*s%s" $x '' "$pcpu_lim" | sed -i "${PCPU_LINE}"'e cat /dev/stdin' $PROD
		fi

		echo "Finished"
		echo "------------------------"

		#### Configuring Deployment file
		echo "Configuring Deployment file for $line ..."

		r='resources:'
		l='limits:'
		m='memory: "$RSRC_MEM_LIM"'
		c='cpu: "$RSRC_CPU_LIM"'
		rev='revisionHistoryLimit: $REV_HIST_LIM'
 
		FLE=$(find $WD/$line/ci/k8s/ -iname "*$line*deployment.yaml")
		if [[ $(echo $FLE | wc -l) -gt 1 ]];then 
			echo "Check $LOG_FILE_ERROR"
			cat <<- BLOCK
  	      	Found more than 1 file for DEPLOYMENT,
  	      	please specify the one you need to edit by temporarily moving the others
			BLOCK >> $LOG_FILE_ERROR
			break
		fi

		declare -i RPL_NUM=$(find $WD/$line/ci/k8s/ -iname "*$line*deployment.yaml" | xargs -I {} cat {} | grep RPL | sed '1s/[^ \t]//g' | wc -c)
		declare -i REV_NUM="$RPL_NUM-2"

		declare -i RPL_LINE=$(find $WD/$line/ci/k8s/ -iname "*$line*deployment.yaml" | xargs -I {} cat {} | nl | grep RPL | cut -d$'\t' -f1 | sed  's/^ *//g')
		#declare -i RPL_LINE=$(awk '/RPL/{ print NR; exit }')
		declare -i REV_LINE="$RPL_LINE+1"

		w=$(grep -c revisionHistoryLimit $FLE)
		if [[ $w == 0 ]]; then
			sed -i '/RPL/ a \ \' $FLE
			printf "%*s%s" $REV_NUM '' "$rev" | sed -i "${REV_LINE}"'e cat /dev/stdin' $FLE
		fi

		declare -i NUM_SPC=$(find $WD/$line/ci/k8s/ -iname "*$line*deployment.yaml" | xargs -I {} cat {} | grep imagePullPolicy | sed '1s/[^ \t]//g' | wc -c)
		declare -i RNUM="$NUM_SPC-2"
		declare -i LNUM="$NUM_SPC"
		declare -i MNUM="$NUM_SPC+2"
		declare -i CNUM="$NUM_SPC+2"

		declare -i LINE=$(find $WD/$line/ci/k8s/ -iname "*$line*deployment.yaml" | xargs -I {} cat {} | nl | grep imagePullPolicy | cut -d$'\t' -f1 | sed  's/^ *//g')
		#declare -i LINE=$(awk '/imagePullPolicy/{ print NR; exit }' )
		declare -i RLINE="$LINE+1"
		declare -i LLINE="$LINE+2"
		declare -i MLINE="$LINE+3"
		declare -i CLINE="$LINE+4"

		w=$(grep -c REV_HIST_LIM $FLE)
		if [[ $w == 0 ]]; then
			sed -i '/imagePullPolicy/ a \ \' $FLE
			printf "%*s%s" $RNUM '' "$r" | sed -i "${RLINE}"'e cat /dev/stdin' $FLE
		fi
		
		w=$(grep -c 'limits:' $FLE)
		if [[ $w == 0 ]]; then
			sed -i '/resources/ a \ \' $FLE
			printf "%*s%s" $LNUM '' "$l" | sed -i "${LLINE}"'e cat /dev/stdin' $FLE
		fi
		
		w=$(grep -c RSRC_MEM_LIM $FLE)
		if [[ $w == 0 ]]; then
			sed -i '/limits/ a \ \' $FLE
			printf "%*s%s" $MNUM '' "$m" | sed -i "${MLINE}"'e cat /dev/stdin' $FLE
		fi
		
		w=$(grep -c RSRC_CPU_LIM $FLE)
		if [[ $w == 0 ]]; then
			sed -i '/RSRC_MEM_LIM/ a \ \' $FLE
			printf "%*s%s" $CNUM '' "$c" | sed -i "${CLINE}"'e cat /dev/stdin' $FLE
		fi

		echo "Finished configuring $line, you must have $LOG_FILE_SUCCESS !"
		echo "-------------------------------------------------------------------------"
		echo ""

		echo "Let's Check syntax for $line !"
		date > $LOG_FILE_SUCCESS
		
		yamllint $WD/$line/ci/k8s/*deployment.yaml >> $LOG_FILE_SUCCESS

		declare -i adl=$(find $WD/$line/ci/k8s -iname "*$line*env-dev" | xargs -I {} cat {} | wc -l)
		declare -i asl=$(find $WD/$line/ci/k8s -iname "*$line*env-stage" | xargs -I {} cat {} | wc -l)
		declare -i apl=$(find $WD/$line/ci/k8s -iname "*$line*env-prod" | xargs -I {} cat {} | wc -l)
		declare -i adepl=$(find $WD/$line/ci/k8s -iname "*$line*deployment.yaml" | xargs -I {} cat {} | wc -l)

		# Check Changed files
		echo "Checking changed files for $line..."
		cd $WD/$line 
		git diff --name-only > $CHNG_FILE
		CNT=$(egrep -c -e "dev|stage|prod|deployment" $CHNG_FILE)
		echo "$CNT files changed within your project !" >> $LOG_FILE_SUCCESS
		echo "" >> $LOG_FILE_SUCCESS
		echo "Here are the files that changed :" >> $LOG_FILE_SUCCESS
		cat $CHNG_FILE >> $LOG_FILE_SUCCESS
		echo "--------------------------------"

		declare -i ddiff=$adl-$bdl
		declare -i sdiff=$asl-$bsl
		declare -i pdiff=$apl-$bpl
		declare -i depdiff=$adepl-$bdepl
		
		echo "$ddiff lines added to $WD/$line/ci/k8s/$line-env-dev" >> $LOG_FILE_SUCCESS
		echo "$sdiff lines added to $WD/$line/ci/k8s/$line-env-stage" >> $LOG_FILE_SUCCESS
		echo "$pdiff lines added to $WD/$line/ci/k8s/$line-env-prod" >> $LOG_FILE_SUCCESS
		echo "$depdiff lines added to $WD/$line/ci/k8s/$line-deployment.yaml" >> $LOG_FILE_SUCCESS
		echo "------------------------------------------" >> $LOG_FILE_SUCCESS

		echo "All Changes for $line completed !! check $LOG_DIR to see if there is any error, then you can commit your changes."
		echo "------------------------------------------------------------------------------------------------------------------"
		echo ""

	done < $FILE_LIST
